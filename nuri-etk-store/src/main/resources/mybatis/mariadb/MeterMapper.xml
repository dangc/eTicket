<?xml version="1.0" encoding="UTF-8"?>
<!--***********************************
* @Copyright : nuritelecom
* @ProjectName : nuri-aimir-etk
* @FileName : MeterMapper.xml
* @Author : jhdang
* @Date : 2020-10
************************************-->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.nuri.etk.store.mapper.DcuMapper">

    <sql id="base_where_list">
        <where>
            <if test="meterId != null" >
                AND meter.MDS_ID = #{meterId}
            </if>
        </where>
    </sql>

    <select id="getMeterInfo" resultType="meterJpo" parameterType="java.lang.String">
        SELECT
            meter.MDS_ID AS meterId
            , cust.customerNo AS customerId
            , cust.name AS customerName
            , cust.ZIPCODE AS geocode
            , cust.address2 AS address
            , cont.lastTokenDate AS lastChargeDate
            , stat.descr AS supplyState
            , cont.currentCredit AS credit
            , cont.currentArrears AS arrears
            , debt.amount AS debtTotal
        FROM
            Customer cust
            LEFT OUTER JOIN (select customer_id,sum(debt_amount) as amount from WS_CMS_DEBTENT where debt_status != 'CANCEL' group by customer_id) debt on cust.customerNo = debt.customer_id
            , Contract cont
            LEFT OUTER JOIN Meter meter on cont.meter_id = meter.id
            LEFT OUTER JOIN Modem modem on meter.modem_id = modem.id
            LEFT OUTER JOIN Mcu mcu on modem.mcu_id = mcu.id
            LEFT OUTER JOIN Code stat on cont.status_id = stat.id
            LEFT OUTER JOIN Code credit on cont.credittype_id = credit.id
            LEFT OUTER JOIN Code tariff on cont.tariffIndex_id = tariff.id
        <include refid="base_where_list" />
    </select>
</mapper>